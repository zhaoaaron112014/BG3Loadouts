<!DOCTYPE html> 
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>BG3Loadouts</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="styles.css"/>
        <link rel="icon" type="image/png" href="favicon.png">
    </head>
    
    <body>
        <div class="loadout" id="loadout">
            <h3>
                HELMETS
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id = "HELMETTable">
                </tbody>
            </table>
            
            <h3>
                CLOAKS
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id = "CLOAKTable">
                </tbody>
            </table>

            <h3>
                BODY
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id = "BODYTable">
                </tbody>
            </table>

            <h3>
                GLOVES
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id = "GLOVESTable">
                </tbody>
            </table>

            <h3>
                BOOTS
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id = "BOOTSTable">
                </tbody>
            </table>

            <h3>
                MELEE WEAPONS/SHIELDS
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id="MELEETable">
                </tbody>
            </table>

            <h3>
                RANGED WEAPONS
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id = "RANGEDTable">
                </tbody>
            </table>

            <h3>
                AMULETS
            </h3>
            <table  class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id="AMULETTable">
                </tbody>
            </table>

            <h3>
                RINGS
            </h3>
            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Remove from Loadout</th>
                    </tr>
                </thead>
                <tbody id="RINGTable">
                </tbody>
            </table>


        </div>
        <div class="searchTable">
            <input type="text" id="searchbar" class="form-control shadow-sm" placeholder = "Search By Name">
            <input type="text" id="themeSearchbar" class="form-control shadow-sm" placeholder = "Search By Theme">
            <input type="text" id="descSearchbar" class="form-control shadow-sm" placeholder = "Search By Description">

            <button type="button" id="clearStorageBtn">Delete Loadout</button>

            <form class="ms-3 mt-3 w-50">
                <select id="category" class="form-select mt-3 mb-3 shadow-sm">
                    <option value="0" selected >All Items</option>
                    <option value="Amulet">Amulet</option>
                    <option value="Shield">Shield</option>
                    <option value="Gloves">Gloves</option>
                    <option value="Body">Body</option>
                    <option value="Helmet">Helmet</option>
                    <option value="Martial">Martial Weapons</option>
                    <option value="Simple">Simple Weapons</option>
                </select>
            </form>

            <table class="table table-striped table-bordered table-light w-100 ms-3 mt-1 searchTable">
                <thead>
                    <tr>
                        <th>ACT</th>
                        <th>NAME</th>
                        <th>RARITY</th>
                        <th>TYPE</th>
                        <th>ARMOR/WEAPON TYPE</th>
                        <th>STATS</th>
                        <th>PROFICIENCY</th>
                        <th>DESCRIPTION</th>
                        <th>THEME</th>
                        <th>SKILLS</th>
                        <th>LOCATION</th>
                        <th>Add to Loadout</th>
                    </tr>
                </thead>

                <tbody id = "tbody">
                </tbody>
            </table>
            

            <script type = "text/javascript">
                let RANGED_WEAPONS = ["LONGBOW", "SHORTBOW", "HEAVY CROSSBOW", "LIGHT CROSSBOW", "HAND CROSSBOW"]

                let MELEE_WEAPONS = ["BATTLEAXE", "CLUB", "DAGGER", "FLAIL", "GLAIVE", "GREATAXE", "GREATCLUB", "GREATSWORD", "HALBERD", "HANDAXE", "JAVELIN", "LIGHT HAMMER", 
                    "LONGSWORD", "MACE", "MAUL", "MORNINGSTAR", "PIKE", "QUARTERSTAFF", "RAPIER", "SCIMITAR", "SHORTSWORD", "SICKLE", "SPEAR", "TRIDENT", "WAR PICK", "WARHAMMER"
                    , "SHIELD"
                ]

                function loadoutRemove(btn){
                    console.log("Deleting Row")
                    var row = btn.parentNode.parentNode;
                    row.parentNode.removeChild(row);
                    console.log(row.children[1].children[0].innerHTML); 
                    localStorage.removeItem(row.children[1].children[0].innerHTML);
                }

                function loadoutAdd(btn){
                    
                    console.log("Button Press")
                    console.log(btn.currentTarget.param)
                    console.log(btn.currentTarget.param.children[3].innerHTML)

                    let name = btn.currentTarget.param.children[1].children[0].innerHTML;
                    console.log(name);
                    if (localStorage.getItem(name) != null){
                        return;
                    }

                    let type = btn.currentTarget.param.children[3].innerHTML;

                    for (i = 0; i < RANGED_WEAPONS.length; i++){
                        if (type == RANGED_WEAPONS[i]){
                            type = "RANGED"
                        }
                    }
                    for (i = 0; i < MELEE_WEAPONS.length; i++){
                        if (type == MELEE_WEAPONS[i]){
                            type = "MELEE"
                        }
                    }

                    let idName = type + "Table";
                    var curr = btn.currentTarget.param;
                    insertToLoadout(idName, curr);
                    

                    localStorage.setItem(curr.children[1].children[0].innerHTML, curr.children[1].children[0].innerHTML);
                }

                function insertToLoadout(idName, curr){
                    var tbodyLoadout = document.getElementById(idName);
                    tbodyLoadout.insertAdjacentHTML('beforeend',
                        `<tr>
                            <td>${curr.children[0].innerHTML}</td>
                            <td>${curr.children[1].innerHTML}</td>
                            <td>${curr.children[2].innerHTML}</td>
                            <td>${curr.children[3].innerHTML}</td>
                            <td>${curr.children[4].innerHTML}</td>
                            <td>${curr.children[5].innerHTML}</td>
                            <td>${curr.children[6].innerHTML}</td>
                            <td>${curr.children[7].innerHTML}</td>
                            <td>${curr.children[8].innerHTML}</td>
                            <td>${curr.children[9].innerHTML}</td>
                            <td>${curr.children[10].innerHTML}</td>
                            <td><input class="remBtn" type="button" value="Remove" onclick = "loadoutRemove(this)"/></td>
                        </tr>`
                    );

                }
                //Clear Local Storage
                var clearStorageBtn = document.getElementById("clearStorageBtn");
                clearStorageBtn.addEventListener("click", clearLocalStorage);
                
                function clearLocalStorage(){
                    localStorage.clear();
                    clearLoadout();
                }

                //Clear Loadout
                function clearLoadout(){
                    console.log("Clearing Loadout")
                    let loadoutArray = ["HELMETTable", "CLOAKTable", "BODYTable", "GLOVESTable", "BOOTSTable", "MELEETable", "RANGEDTable", "AMULETTable", "RINGTable"]

                    for (let i = 0; i < loadoutArray.length; i++){
                        var loadoutTable = document.getElementById(loadoutArray[i]);
                        console.log(loadoutTable);
                        console.log(loadoutTable.childElementCount)
                        for (let j = loadoutTable.childElementCount-1; j >= 0; j--){
                            loadoutTable.deleteRow(j);
                        }
                        
                    }
                }

                var tbody = document.getElementById("tbody");
                var originalData = tbody.innerHTML;
                //Add data from JSON to table
                async function start(){
                    const listEl = document.getElementById("tbody");
                    await fetch('./BG3Items.json').then(res => res.json())
                    .then(data => {
                        data.forEach(post => {
                            let link = ("https://bg3.wiki/wiki/" + post.Name).split(' ').join('_');
                            listEl.insertAdjacentHTML('beforeend', 
                                `<tr>
                                    <td>${post.Act}</td>
                                    <td><a href=${link}>${post.Name}</a></td>
                                    <td>${post.Rarity}</td>
                                    <td>${post.Type}</td>
                                    <td>${post.ArmorWeaponType}</td>
                                    <td>${post.ACDmg}  ${post.SecondDmg}</td>
                                    <td>${post.Proficiency}</td>
                                    <td>${post.Description}</td>
                                    <td>${post.DamageTag}\n ${post.SetTheme}\n ${post.UtilityTag} </td>
                                    <td>${post.GrantedSkills} ${post.Recharge.toUpperCase()}</td>
                                    <td>${post.MapLocation}</td>
                                    <td><button type = "button" class="addBtn">Add</button></td>
                                </tr>`
                            );
                            originalData = tbody.innerHTML
                            
                            
                            
                            if (localStorage.getItem(post.Name) != null){
                                var curr = listEl.lastChild;
                                var type = post.Type;
                                for (i = 0; i < RANGED_WEAPONS.length; i++){
                                    if (type == RANGED_WEAPONS[i]){
                                        type = "RANGED"
                                    }
                                }
                                for (i = 0; i < MELEE_WEAPONS.length; i++){
                                    if (type == MELEE_WEAPONS[i]){
                                        type = "MELEE"
                                    }
                                }
                                var idName = type + "Table";
                                insertToLoadout(idName, curr);


                            }
                        })
                        
                    })

                    //Add selected items to Loadout with buttons
                    let rows = tbody.children;
                    for (let i = 0; i < rows.length; i++){
                        const button = rows[i].children[11];
                        button.addEventListener("click", loadoutAdd)
                        button.param = rows[i];   
                    }
                }
                start();
                
    

                //Filter table by category
                var category = document.getElementById("category");
            
                function filter(){
                    console.log("Filtering" + category.value)
                    if (category.value == '0'){
                        console.log("No Filter")
                        tbody.innerHTML = originalData;
                        return;
                    }
                    
                    tbody.innerHTML = originalData;
                    let filteredRows = '';
                    let rows = tbody.children;
                    
                    let filterType = category.value.toLowerCase();
                    let rowIndex = 3;
                    if (filterType == "martial"){
                        filterType = "m";
                        rowIndex = 6;
                    }
                    if (filterType == "simple"){
                        filterType = "s";
                        rowIndex = 6;
                    }
                    console.log("Rows: " + rows.length + ", Filter: " + filterType);

                    
                    for (let i = 0; i < rows.length; i++){
                        const currentRowType = rows[i].children[rowIndex].innerHTML.toLowerCase();
                        console.log("Current Type: " + currentRowType + ", Filter: " + filterType)
                        if (currentRowType == filterType){
                            filteredRows += rows[i].outerHTML;  
                        }
                    }
                    //console.log("Filtered Rows: " + filteredRows)
                    tbody.innerHTML = filteredRows;

                    for (let i = 0; i < rows.length; i++){
                        const button = rows[i].children[11];
                        button.addEventListener("click", loadoutAdd)
                        button.param = rows[i];   
                    }
                    return;
                }
                category.addEventListener('change', filter);
                
                var searchbar = document.getElementById("searchbar"); 
                let rows = tbody.children;

                searchbar.addEventListener("input", () =>{
                    const searchQuery = searchbar.value.toLowerCase();
                    for (const row of rows){
                        const value = row.children[1].children[0].innerHTML.toLowerCase();
                        row.style.visibility=null;

                        if (value.search(searchQuery) === -1){
                            row.style.visibility = "collapse";
                        }
                    }
                })

                var themeSearchbar = document.getElementById("themeSearchbar"); 
                themeSearchbar.addEventListener("input", () =>{
                    const searchQuery = themeSearchbar.value.toLowerCase();
                    for (const row of rows){
                        const value = row.children[8].innerHTML.toLowerCase();
                        row.style.visibility=null;

                        if (value.search(searchQuery) === -1){
                            row.style.visibility = "collapse";
                        }
                    }
                })

                var descSearchbar = document.getElementById("descSearchbar"); 
                descSearchbar.addEventListener("input", () =>{
                    const searchQuery = descSearchbar.value.toLowerCase();
                    for (const row of rows){
                        const value = row.children[7].innerHTML.toLowerCase();
                        row.style.visibility=null;

                        if (value.search(searchQuery) === -1){
                            row.style.visibility = "collapse";
                        }
                    }
                })


                
        
                

            </script>
        </div>
    </body>

</html>